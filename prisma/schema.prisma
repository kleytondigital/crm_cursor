// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Configuração do seed
// Execute: npm run prisma:seed

model Company {
  id                 String   @id @default(uuid())
  name               String
  slug               String   @unique
  email              String?  @unique
  phone              String?
  document           String?  @unique
  isActive           Boolean  @default(true)
  automationsEnabled Boolean  @default(false) // Controle de acesso às automações
  autoTranscribeAudio Boolean @default(true)  // Transcrição automática de áudios recebidos
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  users              User[]
  leads              Lead[]
  conversations      Conversation[]
  messages           Message[]
  connections        Connection[]
  departments        Department[]
  attendances        Attendance[]
  scheduledMessages  ScheduledMessage[]
  campaigns                Campaign[]
  bulkMessagingCampaigns   BulkMessagingCampaign[]
  apiKeys                  ApiKey[]
  aiAgents           AIAgent[]
  workflowTemplates  WorkflowTemplate[]
  workflowInstances  WorkflowInstance[]
  pipelineStages     PipelineStage[]
  customLeadStatuses CustomLeadStatus[]

  @@map("companies")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(USER)
  isActive  Boolean  @default(true)
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  assignedConversations  Conversation[]
  departmentMemberships  DepartmentUser[]
  attendancesAssigned    Attendance[]       @relation("AttendanceAssignedUser")
  attendancesTransferred Attendance[]       @relation("AttendanceTransferredBy")
  attendancesClosed      Attendance[]       @relation("AttendanceClosedBy")
  attendanceLogs         AttendanceLog[]
  scheduledMessages      ScheduledMessage[]
  createdCampaigns       Campaign[]
  createdBulkMessagingCampaigns BulkMessagingCampaign[]

  @@map("users")
}

enum UserRole {
  ADMIN
  USER
  MANAGER
  SUPER_ADMIN
}

model Lead {
  id               String   @id @default(uuid())
  tenantId         String
  name             String
  phone            String
  email            String?
  document         String?
  statusId         String?
  stageId          String?
  tags             String[]
  profilePictureURL String?
  origin           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  company          Company              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customStatus     CustomLeadStatus?    @relation(fields: [statusId], references: [id], onDelete: SetNull)
  conversations    Conversation[]
  messages         Message[]
  attendances      Attendance[]
  scheduledMessages ScheduledMessage[]

  @@index([tenantId])
  @@index([phone])
  @@index([tenantId, phone])
  @@map("leads")
}

model Conversation {
  id            String             @id @default(uuid())
  tenantId      String
  leadId        String
  assignedUserId String?
  departmentId  String?
  status        ConversationStatus @default(ACTIVE)
  isBotAttending Boolean           @default(false)
  lastMessageAt DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  company       Company            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead          Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedUser User?              @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)
  department   Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  messages      Message[]

  @@index([tenantId])
  @@index([leadId])
  @@index([assignedUserId])
  @@index([departmentId])
  @@index([status])
  @@index([tenantId, status])
  @@map("conversations")
}

enum ConversationStatus {
  ACTIVE
  CLOSED
}

model Message {
  id              String          @id @default(uuid())
  conversationId  String?
  leadId           String?
  connectionId      String?
  senderType        SenderType       @default(LEAD)
  contentType       ContentType      @default(TEXT)
  sender            String?
  contentUrl        String?
  contentText       String?
  transcriptionText String? // Transcrição de áudio via OpenAI Whisper
  latitude          Float?
  longitude         Float?
  direction         MessageDirection @default(INCOMING)
  messageId         String?          @unique
  tempId            String? // ID temporário para correlacionar mensagem otimista com mensagem do servidor
  timestamp         DateTime?
  tenantId          String
  createdAt         DateTime         @default(now())
  reply             Boolean          @default(false)
  replyText         String?
  replyMessageId    String?

  // Campos para histórico de edições/exclusões
  editedAt     DateTime?
  deletedAt    DateTime?
  editedBy     String? // ID do usuário que editou
  deletedBy    String? // ID do usuário que excluiu
  originalText String? // Texto original antes da primeira edição

  company      Company              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conversation Conversation?        @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  lead         Lead?                @relation(fields: [leadId], references: [id], onDelete: SetNull)
  connection   Connection?          @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  editHistory  MessageEditHistory[]

  @@index([tenantId])
  @@index([conversationId])
  @@index([leadId])
  @@index([connectionId])
  @@index([createdAt])
  @@index([senderType])
  @@index([tenantId, createdAt])
  @@index([deletedAt])
  @@map("messages")
}

model MessageEditHistory {
  id        String   @id @default(uuid())
  messageId String
  editedBy  String?
  tenantId  String
  oldText   String
  newText   String
  editedAt  DateTime @default(now())

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([tenantId])
  @@map("message_edit_history")
}

enum SenderType {
  LEAD
  USER
}

enum ContentType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  LOCATION
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

model Connection {
  id           String             @id @default(uuid())
  tenantId     String
  name         String
  sessionName  String             @unique
  provider     ConnectionProvider @default(WHATSAPP)
  status       ConnectionStatus   @default(PENDING)
  webhookUrl   String?
  metadata     Json? // Armazena dados específicos da Meta (pageId, instagramBusinessId, accessToken, etc.)
  refreshToken String? // Token para renovação (Meta OAuth)
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  company           Company            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages          Message[]
  attendances       Attendance[]
  scheduledMessages ScheduledMessage[]
  campaigns         Campaign[]
  bulkMessagingCampaigns BulkMessagingCampaign[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, provider])
  @@index([tenantId, provider, status])
  @@map("connections")
}

enum ConnectionProvider {
  WHATSAPP
  INSTAGRAM
  FACEBOOK
}

enum ConnectionStatus {
  PENDING
  ACTIVE
  STOPPED
  ERROR
}

model Department {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company         Company            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  memberships     DepartmentUser[]
  conversations   Conversation[]
  attendances     Attendance[]
  scheduledMessages ScheduledMessage[]
  aiAgents        AIAgent[]

  @@index([tenantId])
  @@map("departments")
}

model DepartmentUser {
  id           String            @id @default(uuid())
  departmentId String
  userId       String
  role         DepartmentUserRole @default(AGENT)
  createdAt    DateTime          @default(now())

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([departmentId, userId])
  @@index([departmentId])
  @@index([userId])
  @@map("department_users")
}

model Attendance {
  id            String            @id @default(uuid())
  tenantId      String
  leadId        String
  connectionId  String?
  departmentId  String?
  assignedUserId String?
  status        AttendanceStatus  @default(OPEN)
  priority      AttendancePriority @default(NORMAL)
  isUrgent      Boolean           @default(false)
  lastMessage   String?
  lastMessageAt DateTime?
  startedAt     DateTime?
  endedAt       DateTime?
  closedAt      DateTime?
  createdAt     DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  company         Company            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead            Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  connection     Connection?        @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  department     Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  assignedUser   User?              @relation("AttendanceAssignedUser", fields: [assignedUserId], references: [id], onDelete: SetNull)
  transferredBy  User?              @relation("AttendanceTransferredBy", fields: [transferredById], references: [id], onDelete: SetNull)
  closedBy       User?              @relation("AttendanceClosedBy", fields: [closedById], references: [id], onDelete: SetNull)
  transferredById String?
  closedById     String?
  logs           AttendanceLog[]

  @@index([tenantId])
  @@index([leadId])
  @@index([departmentId])
  @@index([assignedUserId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, departmentId, status])
  @@map("attendances")
}

model AttendanceLog {
  id           String            @id @default(uuid())
  attendanceId String
  action       AttendanceLogAction
  performedById String?
  notes         String?
  createdAt     DateTime            @default(now())

  attendance  Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  performedBy User?      @relation(fields: [performedById], references: [id], onDelete: SetNull)

  @@index([attendanceId])
  @@map("attendance_logs")
}

enum DepartmentUserRole {
  ADMIN
  AGENT
}

enum AttendanceStatus {
  OPEN
  IN_PROGRESS
  TRANSFERRED
  CLOSED
}

enum AttendancePriority {
  LOW
  NORMAL
  HIGH
}

enum AttendanceLogAction {
  CREATED
  CLAIMED
  TRANSFERRED
  CLOSED
}

model ScheduledMessage {
  id           String                 @id @default(uuid())
  tenantId     String
  leadId       String?
  connectionId String
  userId       String
  departmentId String?
  contentType  ScheduledContentType
  content      String?
  caption      String?
  scheduledFor DateTime
  sentAt       DateTime?
  status       ScheduledMessageStatus @default(PENDING)
  campaignId   String?
  errorMessage String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  tenant     Company     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead       Lead?       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  connection Connection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  campaign   Campaign?   @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([leadId])
  @@index([connectionId])
  @@index([userId])
  @@index([campaignId])
  @@index([status])
  @@index([scheduledFor])
  @@index([tenantId, status])
  @@index([tenantId, scheduledFor])
  @@map("scheduled_messages")
}

model Campaign {
  id                  String               @id @default(uuid())
  tenantId            String
  name                String
  description         String?
  filterTags          String[]
  filterStages        String[]
  totalLeads          Int                  @default(0)
  scheduledFor        DateTime
  createdById         String
  status              CampaignStatus       @default(DRAFT)
  contentType         ScheduledContentType @default(TEXT)
  content             String?
  caption             String?
  connectionId        String?
  useRandomConnection Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  tenant            Company            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy         User               @relation(fields: [createdById], references: [id], onDelete: Cascade)
  connection        Connection?        @relation(fields: [connectionId], references: [id], onDelete: SetNull)
  scheduledMessages ScheduledMessage[]

  @@index([tenantId])
  @@index([createdById])
  @@index([status])
  @@index([scheduledFor])
  @@index([tenantId, status])
  @@map("campaigns")
}

enum ScheduledContentType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
}

enum ScheduledMessageStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  COMPLETED
  CANCELLED
}

// ============================================
// BULK MESSAGING (Disparo em Massa)
// ============================================

model BulkMessagingCampaign {
  id                  String                      @id @default(uuid())
  tenantId            String
  name                String
  description         String?
  contentType         ScheduledContentType         @default(TEXT)
  content             String?
  caption             String?
  messageSequence     Json?                       // Sequência de mensagens: [{type, content, caption, delay}]
  useRandomGreeting   Boolean                     @default(false) // Usar saudação randômica antes das mensagens
  randomGreetings     String[]                    @default([]) // Lista de saudações randômicas customizadas
  connectionId        String
  totalRecipients     Int                         @default(0)
  sentCount           Int                         @default(0)
  failedCount         Int                         @default(0)
  pendingCount        Int                         @default(0)
  status              BulkMessagingCampaignStatus  @default(DRAFT)
  delayBetweenMessages Int                       @default(2000) // Delay em ms entre mensagens para o mesmo número
  delayBetweenNumbers Int                        @default(5000) // Delay em ms entre números diferentes
  startedAt           DateTime?
  completedAt         DateTime?
  pausedAt            DateTime?
  lastProcessedIndex   Int                        @default(0) // Índice do último destinatário processado (para resumir)
  createdById         String
  createdAt           DateTime                    @default(now())
  updatedAt           DateTime                    @updatedAt

  tenant      Company                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy   User                    @relation(fields: [createdById], references: [id], onDelete: Cascade)
  connection  Connection              @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  recipients  BulkMessagingRecipient[]
  logs        BulkMessagingLog[]

  @@index([tenantId])
  @@index([createdById])
  @@index([status])
  @@index([tenantId, status])
  @@map("bulk_messaging_campaigns")
}

model BulkMessagingRecipient {
  id          String                  @id @default(uuid())
  campaignId  String
  number      String                  // Número do WhatsApp (formato: 5511999999999)
  name        String?                 // Nome do contato
  status      BulkMessagingRecipientStatus @default(PENDING)
  sentAt      DateTime?
  errorMessage String?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  campaign    BulkMessagingCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  logs        BulkMessagingLog[]      @relation("RecipientLogs")

  @@index([campaignId])
  @@index([status])
  @@index([campaignId, status])
  @@map("bulk_messaging_recipients")
}

model BulkMessagingLog {
  id          String                  @id @default(uuid())
  campaignId  String
  recipientId String?
  number      String
  name        String?
  status      BulkMessagingLogStatus
  message     String?
  errorMessage String?
  createdAt   DateTime                @default(now())

  campaign    BulkMessagingCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  recipient   BulkMessagingRecipient? @relation("RecipientLogs", fields: [recipientId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([recipientId])
  @@index([status])
  @@index([campaignId, status])
  @@map("bulk_messaging_logs")
}

enum BulkMessagingCampaignStatus {
  DRAFT
  READY
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
  ERROR
}

enum BulkMessagingRecipientStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

enum BulkMessagingLogStatus {
  SUCCESS
  FAILED
  SKIPPED
  ERROR
}

// ============================================
// N8N INTEGRATION & AI AGENTS
// ============================================

model ApiKey {
  id        String    @id @default(uuid())
  name      String
  key       String    @unique // Hash da chave
  tenantId  String? // Null para Super Admin
  isActive  Boolean   @default(true)
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant Company? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([key])
  @@map("api_keys")
}

model AIAgent {
  id           String   @id @default(uuid())
  name         String
  description  String?
  systemPrompt String   @db.Text
  userPrompt   String?  @db.Text
  model        String   @default("gpt-4")
  temperature  Float    @default(0.7)
  maxTokens    Int      @default(1000)
  tenantId     String
  departmentId String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant            Company            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  department        Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  workflowInstances WorkflowInstance[]

  @@index([tenantId])
  @@index([departmentId])
  @@index([tenantId, isActive])
  @@map("ai_agents")
}

model WorkflowTemplate {
  id              String   @id @default(uuid())
  name            String
  description     String?  @db.Text
  category        String? // Ex: "Atendimento", "Vendas", "Suporte"
  n8nWorkflowData Json // JSON completo do workflow do n8n
  variables       Json // Variáveis editáveis: {systemPrompt: {type: "text", label: "...", default: "..."}}
  icon            String? // Nome do ícone para exibição
  isGlobal        Boolean  @default(true) // true = criado por Super Admin, false = tenant específico
  tenantId        String? // Null se isGlobal = true
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant            Company?           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflowInstances WorkflowInstance[]

  @@index([tenantId])
  @@index([isGlobal, isActive])
  @@index([category])
  @@map("workflow_templates")
}

model WorkflowInstance {
  id               String   @id @default(uuid())
  templateId       String
  n8nWorkflowId    String? // ID do workflow criado no n8n
  webhookUrl       String? // URL do webhook retornado pelo n8n
  webhookName      String? // Nome do webhook retornado pelo n8n
  webhookPath      String? // Path do webhook retornado pelo n8n
  webhookUrlEditor String? // URL do editor do workflow no n8n
  name             String
  config           Json // Configurações personalizadas pelo tenant (valores das variáveis)
  generatedPrompt  String?  @db.Text // Prompt gerado pelo webhook especialista (agentPrompt)
  kanbanEnabled    Boolean  @default(false) // Se a função Kanban está ativada
  kanbanPrompt     String?  @db.Text // Prompt específico da função Kanban
  kanbanStageIds   Json? // IDs dos estágios configurados para Kanban
  testMode         Boolean  @default(false) // Modo teste (true/false)
  testPhone        String? // Telefone para modo teste (formato: 5562999999999@c.us)
  aiAgentId        String?
  tenantId         String
  isActive         Boolean  @default(false) // false até ser ativado no n8n
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  template WorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  aiAgent  AIAgent?         @relation(fields: [aiAgentId], references: [id], onDelete: SetNull)
  tenant   Company          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([templateId])
  @@index([aiAgentId])
  @@index([tenantId, isActive])
  @@index([n8nWorkflowId])
  @@map("workflow_instances")
}

// ============================================
// SYSTEM SETTINGS (Global)
// ============================================

model SystemSettings {
  id        Int      @id @default(1) // Singleton - sempre ID 1
  crmName   String   @default("Darkmode CRM")
  slogan    String   @default("Soluções em atendimento")
  version   String   @default("1.0.0")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

// ============================================
// PIPELINE & LEAD STATUS
// ============================================

model PipelineStage {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  order       Int      @default(0)
  statusId    String
  color       String?  @default("#3B82F6")
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customStatus CustomLeadStatus @relation(fields: [statusId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([tenantId, order])
  @@index([statusId])
  @@map("pipeline_stages")
}

model CustomLeadStatus {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  color       String?  @default("#3B82F6")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company Company        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stages  PipelineStage[]
  leads   Lead[]

  @@index([tenantId])
  @@index([tenantId, order])
  @@map("custom_lead_statuses")
}
