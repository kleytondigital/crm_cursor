{
    "name": "Gestor Meta - Estrutura Completa",
    "nodes": [{
            "id": "webhook",
            "name": "Webhook – Entrada",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [260, 300],
            "parameters": {
                "httpMethod": "POST",
                "path": "gestor-meta",
                "responseMode": "responseNode"
            },
            "webhookId": "gestor-meta"
        },
        {
            "id": "switch",
            "name": "Switch",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [520, 300],
            "parameters": {
                "rules": {
                    "values": [{
                            "conditions": {
                                "conditions": [{
                                    "leftValue": "={{ $json.body.action }}",
                                    "rightValue": "list_contas",
                                    "operator": { "type": "string", "operation": "equals" }
                                }]
                            },
                            "outputKey": "list_contas"
                        },
                        {
                            "conditions": {
                                "conditions": [{
                                    "leftValue": "={{ $json.body.action }}",
                                    "rightValue": "list_campanhas",
                                    "operator": { "type": "string", "operation": "equals" }
                                }]
                            },
                            "outputKey": "list_campanhas"
                        },
                        {
                            "conditions": {
                                "conditions": [{
                                    "leftValue": "={{ $json.body.action }}",
                                    "rightValue": "list_metricas",
                                    "operator": { "type": "string", "operation": "equals" }
                                }]
                            },
                            "outputKey": "list_metricas"
                        }
                    ]
                }
            }
        },


        {
            "id": "listar_contas",
            "name": "Listar Contas de Anúncio",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [840, 140],
            "parameters": {
                "url": "https://graph.facebook.com/v24.0/me/adaccounts",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        { "name": "access_token", "value": "={{ $json.body.userAccessToken }}" },
                        { "name": "fields", "value": "id,name,account_status,currency,business{name,id},timezone_id,spend_cap" }
                    ]
                }
            }
        },
        {
            "id": "normalize_contas",
            "name": "Normalize Contas",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [1080, 140],
            "parameters": {
                "jsCode": "const list = items[0].json.data;\nconst normalized = list.map(acc => ({\n  id: acc.id,\n  name: acc.name,\n  currency: acc.currency,\n  timezone_id: acc.timezone_id,\n  account_status: acc.account_status,\n  spend_cap: acc.spend_cap,\n  business: acc.business || null\n}));\nreturn [{ json: { success: true, data: normalized } }];"
            }
        },


        {
            "id": "listar_campanhas",
            "name": "Listar Campanhas",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [840, 300],
            "parameters": {
                "url": "={{\"https://graph.facebook.com/v24.0/\" + $json.body.adAccountId + \"/campaigns\"}}",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        { "name": "access_token", "value": "={{ $json.body.userAccessToken }}" },
                        {
                            "name": "fields",
                            "value": "id,name,status,effective_status,objective,start_time,stop_time,created_time,updated_time"
                        }
                    ]
                }
            }
        },


        {
            "id": "get_campaigns_metric",
            "name": "Obter Campanhas",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [840, 480],
            "parameters": {
                "url": "={{\"https://graph.facebook.com/v24.0/\" + $json.body.adAccountId + \"/campaigns\"}}",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        { "name": "access_token", "value": "={{ $json.body.userAccessToken }}" },
                        { "name": "fields", "value": "id,name,status" }
                    ]
                }
            }
        },

        {
            "id": "loop_campaigns",
            "name": "Loop Campanhas",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [1080, 480],
            "parameters": {}
        },

        {
            "id": "get_adsets",
            "name": "Listar AdSets",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [1320, 480],
            "parameters": {
                "url": "={{\"https://graph.facebook.com/v24.0/\" + $json.id + \"/adsets\"}}",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        { "name": "access_token", "value": "={{ $('Webhook – Entrada').item.json.body.userAccessToken }}" },
                        { "name": "fields", "value": "id,name,status" }
                    ]
                }
            }
        },

        {
            "id": "loop_adsets",
            "name": "Loop AdSets",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [1560, 480],
            "parameters": {}
        },

        {
            "id": "get_ads",
            "name": "Listar Anúncios",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [1800, 480],
            "parameters": {
                "url": "={{\"https://graph.facebook.com/v24.0/\" + $json.id + \"/ads\"}}",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        { "name": "access_token", "value": "={{ $('Webhook – Entrada').item.json.body.userAccessToken }}" },
                        { "name": "fields", "value": "id,name,creative{effective_object_story_id}" }
                    ]
                }
            }
        },

        {
            "id": "loop_ads",
            "name": "Loop Ads",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 3,
            "position": [2040, 480]
        },

        {
            "id": "get_insights_ad",
            "name": "Insights do Anúncio",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [2280, 480],
            "parameters": {
                "url": "={{\"https://graph.facebook.com/v24.0/\" + $json.id + \"/insights\"}}",
                "sendQuery": true,
                "queryParameters": {
                    "parameters": [
                        { "name": "access_token", "value": "={{ $('Webhook – Entrada').item.json.body.userAccessToken }}" },
                        { "name": "time_range", "value": "={{ `{\\\"since\\\":\\\"${$('Webhook – Entrada').item.json.body.dateStart}\\\",\\\"until\\\":\\\"${$('Webhook – Entrada').item.json.body.dateEnd}\\\"}` }}" },
                        {
                            "name": "fields",
                            "value": "spend,impressions,reach,clicks,actions,action_values,inline_link_clicks,inline_post_engagement,quality_ranking,conversion_rate_ranking,video_plays,video_10_sec_watched_actions"
                        }
                    ]
                }
            }
        },

        {
            "id": "normalize_metrics",
            "name": "Normalize Métricas",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [2520, 480],
            "parameters": {
                "jsCode": "/*\n  Este código consolida:\n  - Métricas totais\n  - Timeline\n  - Ads Breakdown\n*/\n\nconst list = items.map(i => i.json.data ? i.json.data[0] : i.json);\n\nlet total = {\n  spend: 0,\n  impressions: 0,\n  reach: 0,\n  clicks: 0,\n  messages: 0,\n  conversions: 0\n};\n\nlet ads = [];\n\nfor (const insight of list) {\n  if (!insight) continue;\n\n  total.spend += Number(insight.spend || 0);\n  total.impressions += Number(insight.impressions || 0);\n  total.reach += Number(insight.reach || 0);\n  total.clicks += Number(insight.inline_link_clicks || insight.clicks || 0);\n\n  const messages = insight.actions?.find(a => a.action_type === 'onsite_conversion.messaging_first_reply')?.value || 0;\n  const conversions = insight.actions?.find(a => a.action_type === 'offsite_conversion.fb_pixel_purchase')?.value || 0;\n\n  total.messages += Number(messages);\n  total.conversions += Number(conversions);\n\n  ads.push({\n    adId: insight.ad_id,\n    name: insight.ad_name,\n    spend: Number(insight.spend),\n    impressions: Number(insight.impressions),\n    clicks: Number(insight.inline_link_clicks || insight.clicks || 0),\n    messages,\n    ctr: insight.impressions ? insight.clicks / insight.impressions : 0,\n    cpm: insight.impressions ? insight.spend / insight.impressions * 1000 : 0,\n    cpc: insight.clicks ? insight.spend / insight.clicks : 0,\n    cpa: conversions ? insight.spend / conversions : 0\n  });\n}\n\nconst timeline = [];\n\nreturn [{ json: {\n  success: true,\n  data: {\n    metrics: {\n      ...total,\n      cpc: total.clicks ? total.spend / total.clicks : 0,\n      cpm: total.impressions ? total.spend / total.impressions * 1000 : 0,\n      ctr: total.impressions ? total.clicks / total.impressions : 0,\n      cpa: total.conversions ? total.spend / total.conversions : 0,\n      costPerMessage: total.messages ? total.spend / total.messages : 0,\n      conversionRate: total.clicks ? total.conversions / total.clicks : 0\n    },\n    timeline,\n    adsBreakdown: ads\n  }\n}}];"
            }
        },

        {
            "id": "respond",
            "name": "Responder ao Webhook",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [2760, 480],
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}"
            }
        }
    ],

    "connections": {
        "switch": {
            "main": [
                [{ "node": "listar_contas", "type": "main" }],
                [{ "node": "listar_campanhas", "type": "main" }],
                [{ "node": "get_campaigns_metric", "type": "main" }]
            ]
        },

        "listar_contas": {
            "main": [
                [{ "node": "normalize_contas", "type": "main" }]
            ]
        },
        "normalize_contas": {
            "main": [
                [{ "node": "respond", "type": "main" }]
            ]
        },

        "listar_campanhas": {
            "main": [
                [{ "node": "respond", "type": "main" }]
            ]
        },

        "get_campaigns_metric": {
            "main": [
                [{ "node": "loop_campaigns", "type": "main" }]
            ]
        },

        "loop_campaigns": {
            "main": [
                [],
                [{ "node": "get_adsets", "type": "main" }]
            ]
        },

        "get_adsets": {
            "main": [
                [{ "node": "loop_adsets", "type": "main" }]
            ]
        },

        "loop_adsets": {
            "main": [
                [],
                [{ "node": "get_ads", "type": "main" }]
            ]
        },

        "get_ads": {
            "main": [
                [{ "node": "loop_ads", "type": "main" }]
            ]
        },

        "loop_ads": {
            "main": [
                [],
                [{ "node": "get_insights_ad", "type": "main" }]
            ]
        },

        "get_insights_ad": {
            "main": [
                [{ "node": "normalize_metrics", "type": "main" }]
            ]
        },

        "normalize_metrics": {
            "main": [
                [{ "node": "respond", "type": "main" }]
            ]
        },

        "webhook": {
            "main": [
                [{ "node": "switch", "type": "main" }]
            ]
        }
    }
}